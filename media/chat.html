<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<style>
    body.vscode {
        color: var(--vscode-editor-foreground);
        background-color: var(--vscode-editor-background);
        font-family: var(--vscode-font-family);
        font-size: var(--vscode-font-size);
        margin: 0;
        padding: 10px;
        display: flex;
        flex-direction: column;
        height: 98vh;
    }
    body.vscode[data-theme='dark'] .message {
        background-color: #2d2d2d; /* light grey on dark theme */
        color: var(--vscode-editor-foreground);
    }
    body.vscode[data-theme='light'] .message {
        background-color: #f5f5f5; /* lighter grey on light theme */
        color: var(--vscode-editor-foreground);
    }
    #chat {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
    }

    .message {
        max-width: 80%;
        margin: 6px 0;
        padding: 8px 12px;
        border-radius: 10px;
        white-space: pre-wrap;
        background-color: #f0f0f0;
        color: var(--vscode-editor-foreground);
        background-color: var(--vscode-editor-background);
        width: fit-content;  
    }

    .user {
        color: var(--vscode-editor-foreground);
        align-self: flex-end;
        margin-left: auto;
    }

    .bot {
        color: var(--vscode-editor-foreground);
        margin-right: auto;      /* ensures flush left */
        align-self: flex-start;
    }

    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: conic-gradient(from 0deg, #FFA500, #FF6600, #FFA500);
        -webkit-mask:
            radial-gradient(farthest-side, transparent calc(100% - 2px), black calc(100% - 2px));
        mask:
            radial-gradient(farthest-side, transparent calc(100% - 2px), black calc(100% - 2px));
        animation: spin 1s linear infinite;
        margin-left: 5px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }   
    }

    textarea {
        width: 100%;
        height: 60px;
        resize: none;
        padding: 6px 8px;
        background-color: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
    }

    textarea:focus {
        border: 3px solid;
        border-image: linear-gradient(to right, #FFA500, #FF6600) 1;
        outline: none; /* optional to remove default focus outline */
    }
    .input-container {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 8px;
        padding-bottom: 8px;
    }

    button {
        background: linear-gradient(to right, #FFA500, #FF6600);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
    }

    button:disabled {
        opacity: 0.5;
        cursor: wait;
    }
    .container {
        width: 600px;
        max-width: 100%;
        margin: 0 auto;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .gradient-text {
        background: linear-gradient(to right, #FFA500, #FF6600);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        font-weight: bold;
        display: inline-block; 
    }

    .input-container {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 8px;
        padding-bottom: 8px;
    }

    .button-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .modal {
        position: fixed;
        z-index: 9999;
        left: 0; top: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: var(--vscode-editor-background, #fff);
        color: var(--vscode-editor-foreground, #222);
        padding: 24px 32px;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.2);
        min-width: 260px;
    }
    .modal-buttons {
        display: flex;
        gap: 16px;
        justify-content: flex-end;
        margin-top: 16px;
    }
    #input {
        width: 100%;
        min-height: 60px;
        max-height: 400px;
        font-size: 14px;
        padding: 8px;
        resize: none; /* optional: disable manual resizing */
        overflow-y: auto;
        box-sizing: border-box;
    }
    #sessionName {
        width: 100%;
        margin-top: 8px;
        padding: 8px 12px;
        border: 1px solid var(--vscode-editorWidget-border, #ccc);
        background: transparent;
        font-weight: bold;

        /* Gradient text */
        background-image: linear-gradient(90deg, #FFA500, #FF8C00, #FF4500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;

        caret-color: var(--vscode-editor-foreground);
        border-radius: 4px;
        outline: none;
    }

    label[for="sessionName"] {
        display: block;
        margin-bottom: 6px;
    }

    .tabs-wrapper {
        display: flex;
        align-items: center;
        overflow: hidden; /* Hide overflow around button */
        border-bottom: 1px solid var(--vscode-editorWidget-border);
        padding: 4px;
    }

    .tabs {
        display: flex;
        gap: 6px;
        overflow-x: auto;
        white-space: nowrap;
        scrollbar-width: thin; /* For Firefox */
        -ms-overflow-style: auto; /* IE 10+ */
        flex: 1;
    }

    /* Optional: show a scrollbar only when scrolling */
    .tabs::-webkit-scrollbar {
        height: 6px;
    }
    .tabs::-webkit-scrollbar-thumb {
        background-color: var(--vscode-scrollbarSlider-background);
        border-radius: 3px;
    }
    .tabs::-webkit-scrollbar-track {
        background: transparent;
    }

    .tab {
        display: flex;
        align-items: center;
        background: var(--vscode-editor-background);
        color: var(--vscode-editor-foreground);
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid var(--vscode-editorWidget-border);
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
    }

    .tab.active {
        background-image: linear-gradient(90deg, #FFA500, #FF8C00, #FF4500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: var(--vscode-button-foreground);
    }

    .tab .close-btn {
        margin-left: 8px;
        font-weight: bold;
        cursor: pointer;
        color: var(--vscode-editor-foreground);
    }

    #chats{
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
    }
    .chat { 
        display: none; 
    }
    .chat.active { 
        display: block; 
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
    }

</style>
</head>
<body class="vscode">
<div class="container">
    <div id="chats">
        <div id="chat-Chat 1" class="chat active"></div>
    </div>

    <div class="input-container">
        <textarea id="input" placeholder="Ask SIMD.ai..."></textarea>
        <div class="button-column">
            <button id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div id="sessionTabsContainer" class="tabs-wrapper">
        <div id="sessionTabs" class="tabs"></div>
        <button id="newSessionBtn" title="New session">+</button>
    </div>
</div>

<div id="sessionModal" class="modal" style="display:none;">
    <div class="modal-content">
        <label for="sessionName"> <strong>New session name:</strong></label><br />
        <input type="text" id="sessionName" /><br /><br />

        <div class="modal-buttons">
            <button id="createSessionBtn">Create</button>
            <button onclick="document.getElementById('sessionModal').style.display='none'">Cancel</button>
        </div>
        <div id="sessionError" style="color: var(--vscode-editorError-foreground); margin-top: 8px; display: none;"></div>

    </div>
</div>

<script src="${markedUri}"></script>
<script>
    const vscode = acquireVsCodeApi();
    const botLogoUri = "${botLogoUri}";
    const responsePendingSessions = new Set();          // track sessions with pending responses
    const pendingUserMessages = new Map();              // track pending user messages per session
    const input = document.getElementById('input');

    function resizeInput() {
        input.style.height = 'auto'; // reset height
        input.style.height = Math.min(input.scrollHeight, 400) + 'px'; // grow up to 400px
    }

    input.addEventListener('input', resizeInput);
    input.addEventListener('focus', resizeInput);

    function addMessage(text, className, sessionId) {
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }

        const div = document.createElement('div');
        div.classList.add('message', className);
        div.textContent = text;
        chat.appendChild(div);
        const chatsContainer = document.getElementById('chats');
        chatsContainer.scrollTop = chatsContainer.scrollHeight;
    }
    function renderHistory(messages, sessionId) {
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }
        
        // Remove all messages except spinner
        Array.from(chat.children).forEach(child => {
            if (!child.id || !child.id.startsWith('spinner')) {
                child.remove();
            }
        });

        for (const msg of messages) {
            if (msg.startsWith('SIMDAIuser: ')) {
                const userText = msg.replace('SIMDAIuser: ', '');
                addMessage(userText, 'user', sessionId);
            } else if (msg.startsWith('SIMDAIbot: ')) {
                const botText = msg.replace('SIMDAIbot: ', '');
                const botName = 'SIMD.ai';
                const botImageUrl = botLogoUri;
                addBotResponse(botText, botName, botImageUrl, sessionId);
            }
        }

        if (pendingUserMessages.has(sessionId)) {
            const pendingMessage = pendingUserMessages.get(sessionId);
            if (pendingMessage) {
                addMessage(pendingMessage, 'user', sessionId);
            }
        }
        if (responsePendingSessions.has(sessionId)) {
            const oldSpinner = document.getElementById(`spinner-${sessionId}`);
            if (oldSpinner) oldSpinner.remove();
            addSpinner(sessionId);
        }
        const chatsContainer = document.getElementById('chats');
        chatsContainer.scrollTop = chatsContainer.scrollHeight;
        
    }
    function addSpinner(sessionId) {
        
        responsePendingSessions.add(sessionId);
        let chat = document.getElementById(`chat-${sessionId}`);

        if (!chat) {
            const chatsContainer = document.getElementById('chats'); // parent div for all sessions
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }
        if (document.getElementById(`spinner-${sessionId}`)) return;
        const div = document.createElement('div');
        div.className = 'message bot';
        div.id = `spinner-${sessionId}`;
        div.innerHTML = '<span class="gradient-text">SIMD.ai</span> is thinking <span class="spinner"></span>';
        chat.appendChild(div);
        const chatsContainer = document.getElementById('chats');
        chatsContainer.scrollTop = chatsContainer.scrollHeight;
    }

    function removeSpinner(sessionId) {
        responsePendingSessions.delete(sessionId);
        const spinner = document.getElementById(`spinner-${sessionId}`);
        if (spinner) spinner.remove();
    }
    
    
    function codeBlocksToTextareas(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const codeBlocks = doc.querySelectorAll('pre > code');

        codeBlocks.forEach(code => {
            const pre = code.parentElement;
            const decoded = code.innerHTML
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'");

            const id = 'code-' + Math.random().toString(36).substr(2, 9);

            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.marginBottom = '8px';
            wrapper.style.display = 'inline-block';
            wrapper.style.maxWidth = 'inherit';

            const button = document.createElement('button');
            button.className = 'copy-btn';
            button.setAttribute('data-target', id);
            button.style.position = 'absolute';
            button.style.top = '8px';
            button.style.right = '8px';
            button.style.zIndex = '10';
            button.style.padding = '4px 8px';
            button.style.fontSize = '12px';
            button.textContent = 'Copy';

            const textarea = document.createElement('textarea');
            textarea.id = id;
            textarea.className = 'chat-code';
            textarea.readOnly = false;
            textarea.style.width = '400px';
            textarea.style.minHeight = '180px';
            textarea.style.overflowX = 'auto';
            textarea.style.resize = 'both';
            textarea.style.paddingTop = '30px'; 
            textarea.textContent = decoded;
            
            wrapper.appendChild(button);   
            wrapper.appendChild(textarea); 
            pre.replaceWith(wrapper);
        });
        return doc.body.innerHTML;
    }


    function addBotResponse(text, botName, botImageUrl, sessionId) {
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }

        const container = document.createElement('div');
        container.className = 'message bot';
        container.style.display = 'flex';
        container.style.alignItems = 'flex-start';
        container.style.gap = '10px';

        // Bot image
        const img = document.createElement('img');
        img.src = botImageUrl;
        img.alt = botName;
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        img.style.flexShrink = '0';

        // Text container
        const textContainer = document.createElement('div');
        textContainer.style.display = 'flex';
        textContainer.style.flexDirection = 'column';

        const nameElem = document.createElement('div');
        const gradientSpan = document.createElement('span');
        gradientSpan.className = 'gradient-text';
        gradientSpan.textContent = botName;
        nameElem.appendChild(gradientSpan);
        nameElem.style.fontWeight = 'bold';
        nameElem.style.marginBottom = '4px';

        const responseElem = document.createElement('div');
        try {
            let html = marked.parse(text);
            html = codeBlocksToTextareas(html);
            responseElem.innerHTML = html;
        } catch (error) {
            console.error('Error parsing markdown:', error);
            responseElem.textContent = text; // fallback
        }

        textContainer.appendChild(nameElem);
        textContainer.appendChild(responseElem);

        container.appendChild(img);
        container.appendChild(textContainer);

        chat.appendChild(container);
    }
    
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('copy-btn')) {
            const targetId = e.target.getAttribute('data-target');
            const textarea = document.getElementById(targetId);
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = 'Copy', 1000);
            }
        }
    });


    function sendMessage() {
        const input = document.getElementById('input');
        const text = input.value.trim();
        if (!text) return;

        const activeTab = document.querySelector('.tab.active');
        if (!activeTab) return;

        const sessionId = activeTab.dataset.id;

        input.value = '';
        addMessage(text, 'user', sessionId);   // pass sessionId
        pendingUserMessages.set(sessionId, text);
        document.getElementById('sendBtn').disabled = true;

        vscode.postMessage({ type: 'send', text, sessionId });
    }

    function clearChat(sessionId) {
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }

        // Remove everything except spinner
        Array.from(chat.children).forEach(child => {
            if (!child.id || !child.id.startsWith('spinner')) {
                child.remove();
            }
        });
    }

    function insertTextIntoChatInput(text) {
        const chatInput = document.getElementById('input');
        if (!chatInput) return;

        chatInput.value = text;
        chatInput.focus();
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 400) + 'px';
    }

    document.getElementById('input').addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn.disabled) return; // Prevent sending if waiting for reply
            event.preventDefault(); // prevent newline
            sendMessage();
        }
    });

    function createDefaultTabIfMissing() {
        const sessionTabsContainer = document.getElementById('sessionTabs');

        if (![...sessionTabsContainer.querySelectorAll('.tab')].some(tab => tab.dataset.id === 'Chat 1')) {
            createSessionTab('Chat 1', true);
        }
    }
    window.addEventListener('message', event => {
        const message = event.data;
        if (message.type === 'history') {
            clearChat(message.sessionId); 
            renderHistory(message.messages, message.sessionId);
        } else if (message.type === 'responsePending') {
            addSpinner(message.sessionId);
            document.getElementById('sendBtn').disabled = true;
        } else if (message.type === 'response') {
            pendingUserMessages.delete(message.sessionId);
            removeSpinner(message.sessionId);
            const botName = 'SIMD.ai';
            const botImageUrl = botLogoUri;
            addBotResponse(message.text, botName, botImageUrl, message.sessionId);
            document.getElementById('sendBtn').disabled = false;
        } else if (message.command === 'insertUserMessage') {
            insertTextIntoChatInput(message.text);
        } else if (message.type === 'sessionList') {
            const sessionTabsContainer = document.getElementById('sessionTabs');
            sessionTabsContainer.innerHTML = ''; 

            message.sessions.forEach(sessionId => {
                const tab = createSessionTab(sessionId, sessionId === message.currentSession);
            });
        } else if (message.type === 'error') {
            removeSpinner(message.sessionId);
            showError(`⚠️ ${message.error}`, message.sessionId);
            document.getElementById('sendBtn').disabled = false;
        }
    });
    

    

    function showError(msg, sessionId) {
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }

        const container = document.createElement('div');
        container.className = 'message error';
        container.style.color = 'red';
        container.textContent = msg;
        chat.appendChild(container);
        chat.scrollTop = chat.scrollHeight;
    }
    
    function createSessionTab(sessionId, isActive = false) {
        const sessionTabsContainer = document.getElementById('sessionTabs');
        const tab = document.createElement('div');
        tab.classList.add('tab');
        tab.dataset.id = sessionId;
        tab.textContent = sessionId;

        if (isActive) {
            selectSessionTab(tab);
        }

        const closeBtn = document.createElement('span');
        closeBtn.textContent = '✕';
        closeBtn.classList.add('close-btn');

        closeBtn.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            tab.remove();
            vscode.postMessage({ type: 'deleteSession', sessionId });

            const remainingTabs = [...sessionTabsContainer.querySelectorAll('.tab')];
            const newActive = remainingTabs[0];

            if (newActive) {
                selectSessionTab(newActive);
                vscode.postMessage({ type: 'switchSession', sessionId: newActive.dataset.id });
                vscode.postMessage({ type: 'requestHistory', sessionId: newActive.dataset.id });
            } else {
                createDefaultTabIfMissing();
                vscode.postMessage({ type: 'switchSession', sessionId: 'Chat 1' });
                vscode.postMessage({ type: 'requestHistory', sessionId: 'Chat 1' });
            }
        };

        tab.appendChild(closeBtn);

        tab.addEventListener('click', () => {
            selectSessionTab(tab);
            vscode.postMessage({ type: 'switchSession', sessionId });
            vscode.postMessage({ type: 'requestHistory', sessionId });
        });

        sessionTabsContainer.appendChild(tab);
        return tab;
    }

    
    function selectSessionTab(tabElement) {
        const sessionId = tabElement.dataset.id;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        tabElement.classList.add('active');

        document.querySelectorAll('.chat').forEach(chat => chat.classList.remove('active'));
        let chat = document.getElementById(`chat-${sessionId}`);
        if (!chat) {
            const chatsContainer = document.getElementById('chats');
            chat = document.createElement('div');
            chat.id = `chat-${sessionId}`;
            chat.classList.add('chat');
            chatsContainer.appendChild(chat);
        }
        document.querySelectorAll('.chat').forEach(c => c.classList.remove('active'));
        chat.classList.add('active');

        // Request history from extension **every time we switch**
        vscode.postMessage({ type: 'switchSession', sessionId });
        vscode.postMessage({ type: 'requestHistory', sessionId });
        
        
        localStorage.setItem('lastActiveSession', sessionId);
    }

    document.getElementById('sessionTabs').addEventListener('click', (e) => {
        let currentSessionId = 'Chat 1';
        const closeBtn = e.target.closest('.close-btn');
        const tab = e.target.closest('.tab');

        if (closeBtn && tab) {
            const sessionId = tab.dataset.id;
            tab.remove();
            vscode.postMessage({ type: 'deleteSession', sessionId });
            
            if (sessionId === currentSessionId) {
                const firstTab = document.querySelector('.tab');
                if (firstTab) selectSessionTab(firstTab);
            }
            return;
        }

        if (tab) selectSessionTab(tab);
    });

    document.getElementById('newSessionBtn').addEventListener('click', () => {
        document.getElementById('sessionModal').style.display = 'flex';

        const input = document.getElementById('sessionName');
        input.focus();
    });

    document.getElementById('createSessionBtn').addEventListener('click', () => {
        const sessionId = document.getElementById('sessionName').value.trim();
        if (sessionId) {
            const sessionTabsContainer = document.getElementById('sessionTabs');
            const errorDiv = document.getElementById('sessionError');
            const defaultTab = document.createElement('div');
            defaultTab.classList.add('tab', 'active');
            defaultTab.dataset.id = 'Chat 1';
            defaultTab.textContent = 'Chat 1';

            const alreadyExists = [...sessionTabsContainer.children].some(tab => tab.dataset.id === sessionId);
            if (alreadyExists) {
                showError('Session name already exists.');
                return;
            } else {
                errorDiv.style.display = 'none';
            }
            createSessionTab(sessionId, true);
            vscode.postMessage({ type: 'switchSession', sessionId });
            
            document.getElementById('sessionModal').style.display = 'none';
            document.getElementById('sessionName').value = '';
        }
    });


    document.getElementById('sessionName').addEventListener('input', () => {
        document.getElementById('sessionError').style.display = 'none';
    });
    document.addEventListener('DOMContentLoaded', () => {
        const defaultSessionId = 'Chat 1';
        
        const sessionNameInput = document.getElementById('sessionName');
        const sessionModal = document.getElementById('sessionModal');
        const sessionError = document.getElementById('sessionError');
        const createSessionBtn = document.getElementById('createSessionBtn');
        const lastSessionId = localStorage.getItem('lastActiveSession') || defaultSessionId;

        sessionNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                createSessionBtn.click(); // triggers create
            } else if (e.key === 'Escape') {
                e.preventDefault();
                sessionModal.style.display = 'none'; // closes modal
                sessionError.style.display = 'none'; // optionally hide error
                sessionNameInput.value = '';
            }
        });
        vscode.postMessage({ type: 'switchSession', sessionId: lastSessionId });
        vscode.postMessage({ type: 'requestHistory', sessionId: lastSessionId });
        vscode.postMessage({ type: 'requestSessionList' });
    });
</script>
</body>
</html>